// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`HTTP API Gateway creates API-GW HTTP API using IAM auth and ALB integration 1`] = `
Object {
  "Resources": Object {
    "ApigwExternalCallerRoleD686A82A": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "AWS": Object {
                  "Fn::Join": Array [
                    "",
                    Array [
                      "arn:",
                      Object {
                        "Ref": "AWS::Partition",
                      },
                      ":iam::12312312:root",
                    ],
                  ],
                },
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Description": "Allows external users to access the API-GW for 'my-test-alb-api.example.com' if they can assume this role.",
      },
      "Type": "AWS::IAM::Role",
    },
    "ApigwExternalCallerRoleDefaultPolicyA94F9D25": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "execute-api:Invoke",
              "Effect": "Allow",
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    "arn:",
                    Object {
                      "Ref": "AWS::Partition",
                    },
                    ":execute-api:eu-west-1:",
                    Object {
                      "Ref": "AWS::AccountId",
                    },
                    ":",
                    Object {
                      "Ref": "TestAlbApiGatewayHttpApimytestalbapiAB236F67",
                    },
                    "/*/*/api",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ApigwExternalCallerRoleDefaultPolicyA94F9D25",
        "Roles": Array [
          Object {
            "Ref": "ApigwExternalCallerRoleD686A82A",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "DnsARecordFED6ED67": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::Join": Array [
              "",
              Array [
                "dualstack.",
                Object {
                  "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancer8E47CE52DNSName59BE487A",
                },
              ],
            ],
          },
          "HostedZoneId": Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancer8E47CE52CanonicalHostedZoneID7C0E7DD7",
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-service-behind-alb.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "DnsListenerRule18B182CC": Object {
      "Properties": Object {
        "Actions": Array [
          Object {
            "TargetGroupArn": Object {
              "Ref": "ServiceTargetGroupE74A3394",
            },
            "Type": "forward",
          },
        ],
        "Conditions": Array [
          Object {
            "Field": "host-header",
            "HostHeaderConfig": Object {
              "Values": Array [
                "my-test-service-behind-alb.example.com",
              ],
            },
          },
        ],
        "ListenerArn": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefLoadBalancerHttpsListener68D81C9458BEEF85",
        },
        "Priority": 10,
      },
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
    },
    "Service9571FDD8": Object {
      "DependsOn": Array [
        "DnsListenerRule18B182CC",
        "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3",
        "ServiceTaskDefinitionTaskRole3BD32B0F",
      ],
      "Properties": Object {
        "Cluster": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefClusterEB0386A796A0E3FE",
        },
        "DeploymentConfiguration": Object {
          "Alarms": Object {
            "AlarmNames": Array [],
            "Enable": false,
            "Rollback": false,
          },
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
        },
        "DesiredCount": 2,
        "EnableECSManagedTags": false,
        "EnableExecuteCommand": true,
        "HealthCheckGracePeriodSeconds": 60,
        "LaunchType": "FARGATE",
        "LoadBalancers": Array [
          Object {
            "ContainerName": "Container",
            "ContainerPort": 8080,
            "TargetGroupArn": Object {
              "Ref": "ServiceTargetGroupE74A3394",
            },
          },
        ],
        "NetworkConfiguration": Object {
          "AwsvpcConfiguration": Object {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": Array [
              Object {
                "Fn::GetAtt": Array [
                  "ServiceSecurityGroupC96ED6A7",
                  "GroupId",
                ],
              },
            ],
            "Subnets": Array [
              Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPublicSubnet1Subnet5C2D37C4FFA2B456",
              },
              Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPublicSubnet2Subnet691E08A351552740",
              },
            ],
          },
        },
        "PlatformVersion": "1.4.0",
        "ServiceName": "example-service",
        "TaskDefinition": Object {
          "Ref": "ServiceTaskDefinition55FA0F15",
        },
      },
      "Type": "AWS::ECS::Service",
    },
    "ServiceLogGroupB910EE76": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 14,
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "ServiceSecurityGroupC96ED6A7": Object {
      "Properties": Object {
        "GroupDescription": "Stack/Service/SecurityGroup",
        "SecurityGroupEgress": Array [
          Object {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic by default",
            "IpProtocol": "-1",
          },
        ],
        "VpcId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefVpc8378EB38272D6E3A",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "ServiceSecurityGroupSupportStackLoadBalancerSecurityGroup0F63AB0C8080from36CDC9C8": Object {
      "Properties": Object {
        "Description": "Load balancer to target",
        "DestinationSecurityGroupId": Object {
          "Fn::GetAtt": Array [
            "ServiceSecurityGroupC96ED6A7",
            "GroupId",
          ],
        },
        "FromPort": 8080,
        "GroupId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
        },
        "IpProtocol": "tcp",
        "ToPort": 8080,
      },
      "Type": "AWS::EC2::SecurityGroupEgress",
    },
    "ServiceSecurityGroupfromSupportStackLoadBalancerSecurityGroup0F63AB0C80803CEA72C3": Object {
      "Properties": Object {
        "Description": "Load balancer to target",
        "FromPort": 8080,
        "GroupId": Object {
          "Fn::GetAtt": Array [
            "ServiceSecurityGroupC96ED6A7",
            "GroupId",
          ],
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
        },
        "ToPort": 8080,
      },
      "Type": "AWS::EC2::SecurityGroupIngress",
    },
    "ServiceTargetGroupE74A3394": Object {
      "Properties": Object {
        "HealthCheckIntervalSeconds": 10,
        "HealthCheckPath": "/health",
        "HealthyThresholdCount": 2,
        "Port": 8080,
        "Protocol": "HTTP",
        "TargetGroupAttributes": Array [
          Object {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "15",
          },
          Object {
            "Key": "stickiness.enabled",
            "Value": "false",
          },
        ],
        "TargetType": "ip",
        "VpcId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefVpc8378EB38272D6E3A",
        },
      },
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
    },
    "ServiceTaskDefinition55FA0F15": Object {
      "Properties": Object {
        "ContainerDefinitions": Array [
          Object {
            "Environment": Array [
              Object {
                "Name": "SSM_PREFIX",
                "Value": "/liflig-cdk/Stack/c8cabff989df74f9b2755f4ae923cc6492f944970b/parameters",
              },
              Object {
                "Name": "PARAMS_HASH",
                "Value": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
              },
            ],
            "Essential": true,
            "Image": Object {
              "Fn::Join": Array [
                "",
                Array [
                  Object {
                    "Fn::Select": Array [
                      4,
                      Object {
                        "Fn::Split": Array [
                          ":",
                          Object {
                            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
                          },
                        ],
                      },
                    ],
                  },
                  ".dkr.ecr.",
                  Object {
                    "Fn::Select": Array [
                      3,
                      Object {
                        "Fn::Split": Array [
                          ":",
                          Object {
                            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
                          },
                        ],
                      },
                    ],
                  },
                  ".",
                  Object {
                    "Ref": "AWS::URLSuffix",
                  },
                  "/",
                  Object {
                    "Fn::ImportValue": "SupportStack:ExportsOutputRefRepository22E53BBD9A9E013B",
                  },
                  ":exampleEcrTag",
                ],
              ],
            },
            "LinuxParameters": Object {
              "Capabilities": Object {},
              "InitProcessEnabled": true,
            },
            "LogConfiguration": Object {
              "LogDriver": "awslogs",
              "Options": Object {
                "awslogs-datetime-format": "%Y-%m-%dT%H:%M:%S",
                "awslogs-group": Object {
                  "Ref": "ServiceLogGroupB910EE76",
                },
                "awslogs-region": "eu-west-1",
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "Container",
            "PortMappings": Array [
              Object {
                "ContainerPort": 8080,
                "HostPort": 8080,
                "Protocol": "tcp",
              },
            ],
          },
        ],
        "Cpu": "256",
        "ExecutionRoleArn": Object {
          "Fn::GetAtt": Array [
            "ServiceTaskDefinitionExecutionRole5D3DB197",
            "Arn",
          ],
        },
        "Family": "StackServiceTaskDefinition81B5CCD5",
        "Memory": "512",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": Array [
          "FARGATE",
        ],
        "TaskRoleArn": Object {
          "Fn::GetAtt": Array [
            "ServiceTaskDefinitionTaskRole3BD32B0F",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "ServiceTaskDefinitionExecutionRole5D3DB197": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ServiceTaskDefinitionExecutionRoleDefaultPolicyE16C69DE": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
              },
            },
            Object {
              "Action": "ecr:GetAuthorizationToken",
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "ServiceLogGroupB910EE76",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ServiceTaskDefinitionExecutionRoleDefaultPolicyE16C69DE",
        "Roles": Array [
          Object {
            "Ref": "ServiceTaskDefinitionExecutionRole5D3DB197",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "ServiceTaskDefinitionTaskRole3BD32B0F": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    "arn:aws:ssm:eu-west-1:",
                    Object {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/liflig-cdk/Stack/c8cabff989df74f9b2755f4ae923cc6492f944970b/parameters/*",
                  ],
                ],
              },
            },
            Object {
              "Action": Array [
                "ssmmessages:CreateControlChannel",
                "ssmmessages:CreateDataChannel",
                "ssmmessages:OpenControlChannel",
                "ssmmessages:OpenDataChannel",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": "logs:DescribeLogGroups",
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3",
        "Roles": Array [
          Object {
            "Ref": "ServiceTaskDefinitionTaskRole3BD32B0F",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestAlbApiGatewayAccessLogsAccessLogGroup7E220BEE": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 180,
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-alb-api",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "TestAlbApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRole0FAC7432": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-alb-api",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestAlbApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicy41CE8920": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "TestAlbApiGatewayAccessLogsAccessLogGroup7E220BEE",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestAlbApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicy41CE8920",
        "Roles": Array [
          Object {
            "Ref": "TestAlbApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRole0FAC7432",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestAlbApiGatewayAlbVpcLink8545174C": Object {
      "Properties": Object {
        "Name": "StackTestAlbApiGatewayAlbVpcLink4446391B",
        "SecurityGroupIds": Array [
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
          },
        ],
        "SubnetIds": Array [
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet1Subnet536B997AFD4CC940",
          },
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet2Subnet3788AAA1380949A3",
          },
        ],
        "Tags": Object {
          "service": "my-test-alb-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::VpcLink",
    },
    "TestAlbApiGatewayCustomDomainDomainNamemytestalbapi6FFE7118": Object {
      "Properties": Object {
        "DomainName": "my-test-alb-api.example.com",
        "DomainNameConfigurations": Array [
          Object {
            "CertificateArn": Object {
              "Ref": "TestAlbApiGatewayCustomDomainHttpsCertificateDE9D17D8",
            },
            "EndpointType": "REGIONAL",
            "SecurityPolicy": "TLS_1_2",
          },
        ],
        "Tags": Object {
          "service": "my-test-alb-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::DomainName",
    },
    "TestAlbApiGatewayCustomDomainHttpsCertificateDE9D17D8": Object {
      "Properties": Object {
        "DomainName": "my-test-alb-api.example.com",
        "DomainValidationOptions": Array [
          Object {
            "DomainName": "my-test-alb-api.example.com",
            "HostedZoneId": Object {
              "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
            },
          },
        ],
        "Tags": Array [
          Object {
            "Key": "Name",
            "Value": "Stack/TestAlbApiGateway/CustomDomain/HttpsCertificate",
          },
          Object {
            "Key": "service",
            "Value": "my-test-alb-api",
          },
        ],
        "ValidationMethod": "DNS",
      },
      "Type": "AWS::CertificateManager::Certificate",
    },
    "TestAlbApiGatewayCustomDomainRoute53ARecordApigwAlias7AC51E7D": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::GetAtt": Array [
              "TestAlbApiGatewayCustomDomainDomainNamemytestalbapi6FFE7118",
              "RegionalDomainName",
            ],
          },
          "HostedZoneId": Object {
            "Fn::GetAtt": Array [
              "TestAlbApiGatewayCustomDomainDomainNamemytestalbapi6FFE7118",
              "RegionalHostedZoneId",
            ],
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-alb-api.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "TestAlbApiGatewayHttpApimytestalbapiAB236F67": Object {
      "Properties": Object {
        "Description": "An HTTP API for my-test-alb-api.example.com.",
        "DisableExecuteApiEndpoint": true,
        "Name": "HttpApi-my-test-alb-api",
        "ProtocolType": "HTTP",
        "Tags": Object {
          "service": "my-test-alb-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::Api",
    },
    "TestAlbApiGatewayHttpApimytestalbapiDefaultStage5592DA67": Object {
      "DependsOn": Array [
        "TestAlbApiGatewayCustomDomainDomainNamemytestalbapi6FFE7118",
      ],
      "Properties": Object {
        "AccessLogSettings": Object {
          "DestinationArn": Object {
            "Fn::GetAtt": Array [
              "TestAlbApiGatewayAccessLogsAccessLogGroup7E220BEE",
              "Arn",
            ],
          },
          "Format": "{\\"requestId\\":\\"$context.requestId\\",\\"userAgent\\":\\"$context.identity.userAgent\\",\\"ip\\":\\"$context.identity.sourceIp\\",\\"requestTime\\":\\"$context.requestTime\\",\\"requestTimeEpoch\\":\\"$context.requestTimeEpoch\\",\\"dataProcessed\\":\\"$context.dataProcessed\\",\\"httpMethod\\":\\"$context.httpMethod\\",\\"path\\":\\"$context.path\\",\\"routeKey\\":\\"$context.routeKey\\",\\"status\\":\\"$context.status\\",\\"protocol\\":\\"$context.protocol\\",\\"responseLength\\":\\"$context.responseLength\\",\\"responseLatency\\":\\"$context.responseLatency\\",\\"domainName\\":\\"$context.domainName\\",\\"error\\":{\\"type\\":\\"$context.error.responseType\\",\\"gatewayError\\":\\"$context.error.message\\",\\"integrationError\\":\\"$context.integration.error\\",\\"authorizerError\\":\\"$context.authorizer.error\\"},\\"integration\\":{\\"latency\\":\\"$context.integration.latency\\",\\"requestId\\":\\"$context.integration.requestId\\",\\"responseStatus\\":\\"$context.integration.status\\"},\\"auth\\":{\\"iam\\":{\\"userArn\\":\\"$context.identity.userArn\\",\\"awsAccount\\":\\"$context.identity.accountId\\",\\"awsPrincipal\\":\\"$context.identity.caller\\",\\"awsPrincipalOrg\\":\\"$context.identity.principalOrgId\\"},\\"basic\\":{\\"user\\":\\"$context.authorizer.user\\"}},\\"awsEndpointRequest\\":{\\"id\\":\\"$context.awsEndpointRequestId\\",\\"id2\\":\\"$context.awsEndpointRequestId2\\"},\\"message\\":\\"$context.identity.sourceIp - $context.httpMethod $context.domainName $context.path ($context.routeKey) - $context.status [$context.responseLatency ms]\\"}",
        },
        "ApiId": Object {
          "Ref": "TestAlbApiGatewayHttpApimytestalbapiAB236F67",
        },
        "AutoDeploy": true,
        "DefaultRouteSettings": Object {
          "DetailedMetricsEnabled": true,
        },
        "StageName": "$default",
        "Tags": Object {
          "service": "my-test-alb-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::Stage",
    },
    "TestAlbApiGatewayHttpApimytestalbapiDefaultStageStackTestAlbApiGatewayCustomDomainDomainNamemytestalbapiundefined3B456C62": Object {
      "DependsOn": Array [
        "TestAlbApiGatewayCustomDomainDomainNamemytestalbapi6FFE7118",
        "TestAlbApiGatewayHttpApimytestalbapiDefaultStage5592DA67",
      ],
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestAlbApiGatewayHttpApimytestalbapiAB236F67",
        },
        "DomainName": Object {
          "Ref": "TestAlbApiGatewayCustomDomainDomainNamemytestalbapi6FFE7118",
        },
        "Stage": "$default",
      },
      "Type": "AWS::ApiGatewayV2::ApiMapping",
    },
    "TestAlbApiGatewayRouteapi6B9142B2": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestAlbApiGatewayHttpApimytestalbapiAB236F67",
        },
        "AuthorizationType": "AWS_IAM",
        "RouteKey": "ANY /api",
        "Target": Object {
          "Fn::Join": Array [
            "",
            Array [
              "integrations/",
              Object {
                "Ref": "TestAlbApiGatewayRouteapiAlbIntegrationmytestalbapiBDC75179",
              },
            ],
          ],
        },
      },
      "Type": "AWS::ApiGatewayV2::Route",
    },
    "TestAlbApiGatewayRouteapiAlbIntegrationmytestalbapiBDC75179": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestAlbApiGatewayHttpApimytestalbapiAB236F67",
        },
        "ConnectionId": Object {
          "Ref": "TestAlbApiGatewayAlbVpcLink8545174C",
        },
        "ConnectionType": "VPC_LINK",
        "IntegrationMethod": "ANY",
        "IntegrationType": "HTTP_PROXY",
        "IntegrationUri": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefLoadBalancerHttpsListener68D81C9458BEEF85",
        },
        "PayloadFormatVersion": "1.0",
        "RequestParameters": Object {
          "overwrite:header.Host": "my-test-service-behind-alb.example.com",
        },
        "TlsConfig": Object {
          "ServerNameToVerify": "my-test-service-behind-alb.example.com",
        },
      },
      "Type": "AWS::ApiGatewayV2::Integration",
    },
  },
}
`;

exports[`HTTP API Gateway creates API-GW HTTP API using basic auth and SQS integration 1`] = `
Object {
  "Resources": Object {
    "BasicAuthCredentialsSecretED3C53F8": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "Name": "/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials",
        "SecretString": "{\\"username\\":\\"test-user\\",\\"password\\":\\"test-password\\"}",
      },
      "Type": "AWS::SecretsManager::Secret",
      "UpdateReplacePolicy": "Delete",
    },
    "IngressQueue5DC71407": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "QueueName": "api-ingress-queue",
      },
      "Type": "AWS::SQS::Queue",
      "UpdateReplacePolicy": "Delete",
    },
    "TestSqsApiGatewayAccessLogsAccessLogGroup74216414": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 180,
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-sqs-api",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "TestSqsApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleC01F2CE7": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-sqs-api",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestSqsApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyD3425EEC": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "TestSqsApiGatewayAccessLogsAccessLogGroup74216414",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestSqsApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyD3425EEC",
        "Roles": Array [
          Object {
            "Ref": "TestSqsApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleC01F2CE7",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestSqsApiGatewayApiGwToIngressQueueServiceRole1A7D8DD4": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Description": Object {
          "Fn::Join": Array [
            "",
            Array [
              "Allows API-GW to add messages to ",
              Object {
                "Fn::GetAtt": Array [
                  "IngressQueue5DC71407",
                  "Arn",
                ],
              },
            ],
          ],
        },
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-sqs-api",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestSqsApiGatewayApiGwToIngressQueueServiceRoleDefaultPolicyD502C275": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "sqs:SendMessage",
                "sqs:GetQueueAttributes",
                "sqs:GetQueueUrl",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "IngressQueue5DC71407",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestSqsApiGatewayApiGwToIngressQueueServiceRoleDefaultPolicyD502C275",
        "Roles": Array [
          Object {
            "Ref": "TestSqsApiGatewayApiGwToIngressQueueServiceRole1A7D8DD4",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestSqsApiGatewayCustomDomainDomainNamemytestsqsapi0D7817A7": Object {
      "Properties": Object {
        "DomainName": "my-test-sqs-api.example.com",
        "DomainNameConfigurations": Array [
          Object {
            "CertificateArn": Object {
              "Ref": "TestSqsApiGatewayCustomDomainHttpsCertificateBCD3A41A",
            },
            "EndpointType": "REGIONAL",
            "SecurityPolicy": "TLS_1_2",
          },
        ],
        "Tags": Object {
          "service": "my-test-sqs-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::DomainName",
    },
    "TestSqsApiGatewayCustomDomainHttpsCertificateBCD3A41A": Object {
      "Properties": Object {
        "DomainName": "my-test-sqs-api.example.com",
        "DomainValidationOptions": Array [
          Object {
            "DomainName": "my-test-sqs-api.example.com",
            "HostedZoneId": Object {
              "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
            },
          },
        ],
        "Tags": Array [
          Object {
            "Key": "Name",
            "Value": "Stack/TestSqsApiGateway/CustomDomain/HttpsCertificate",
          },
          Object {
            "Key": "service",
            "Value": "my-test-sqs-api",
          },
        ],
        "ValidationMethod": "DNS",
      },
      "Type": "AWS::CertificateManager::Certificate",
    },
    "TestSqsApiGatewayCustomDomainRoute53ARecordApigwAliasDFF0214F": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::GetAtt": Array [
              "TestSqsApiGatewayCustomDomainDomainNamemytestsqsapi0D7817A7",
              "RegionalDomainName",
            ],
          },
          "HostedZoneId": Object {
            "Fn::GetAtt": Array [
              "TestSqsApiGatewayCustomDomainDomainNamemytestsqsapi0D7817A7",
              "RegionalHostedZoneId",
            ],
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-sqs-api.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambda7560641C": Object {
      "DependsOn": Array [
        "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambdaServiceRoleDefaultPolicyDD1F37C0",
        "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambdaServiceRole9AB1D2BF",
      ],
      "Properties": Object {
        "Code": Object {
          "S3Bucket": Object {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-1",
          },
          "S3Key": "f30c6a29e8e7ba0e9623f83c716fb2c20ee2a00d566758b4b9704e920bc2f68e.zip",
        },
        "Description": "An authorizer for API-Gateway that checks Basic Auth credentials on requests",
        "Environment": Object {
          "Variables": Object {
            "CREDENTIALS_SECRET_NAME": "/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials",
          },
        },
        "Handler": "index.handler",
        "Role": Object {
          "Fn::GetAtt": Array [
            "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambdaServiceRole9AB1D2BF",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-sqs-api",
          },
        ],
      },
      "Type": "AWS::Lambda::Function",
    },
    "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambdaServiceRole9AB1D2BF": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-sqs-api",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambdaServiceRoleDefaultPolicyDD1F37C0": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    "arn:",
                    Object {
                      "Ref": "AWS::Partition",
                    },
                    ":secretsmanager:eu-west-1:",
                    Object {
                      "Ref": "AWS::AccountId",
                    },
                    ":secret:/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials-??????",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambdaServiceRoleDefaultPolicyDD1F37C0",
        "Roles": Array [
          Object {
            "Ref": "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambdaServiceRole9AB1D2BF",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestSqsApiGatewayHttpApimytestsqsapiBE5B3270": Object {
      "Properties": Object {
        "Description": "An HTTP API for my-test-sqs-api.example.com.",
        "DisableExecuteApiEndpoint": true,
        "Name": "HttpApi-my-test-sqs-api",
        "ProtocolType": "HTTP",
        "Tags": Object {
          "service": "my-test-sqs-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::Api",
    },
    "TestSqsApiGatewayHttpApimytestsqsapiDefaultAuthorizerB4F89C21": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestSqsApiGatewayHttpApimytestsqsapiBE5B3270",
        },
        "AuthorizerPayloadFormatVersion": "2.0",
        "AuthorizerResultTtlInSeconds": 1800,
        "AuthorizerType": "REQUEST",
        "AuthorizerUri": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:",
              Object {
                "Ref": "AWS::Partition",
              },
              ":apigateway:eu-west-1:lambda:path/2015-03-31/functions/",
              Object {
                "Fn::GetAtt": Array [
                  "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambda7560641C",
                  "Arn",
                ],
              },
              "/invocations",
            ],
          ],
        },
        "EnableSimpleResponses": true,
        "IdentitySource": Array [
          "$request.header.Authorization",
        ],
        "Name": "DefaultAuthorizer",
      },
      "Type": "AWS::ApiGatewayV2::Authorizer",
    },
    "TestSqsApiGatewayHttpApimytestsqsapiDefaultStageDF90C8F9": Object {
      "DependsOn": Array [
        "TestSqsApiGatewayCustomDomainDomainNamemytestsqsapi0D7817A7",
      ],
      "Properties": Object {
        "AccessLogSettings": Object {
          "DestinationArn": Object {
            "Fn::GetAtt": Array [
              "TestSqsApiGatewayAccessLogsAccessLogGroup74216414",
              "Arn",
            ],
          },
          "Format": "{\\"requestId\\":\\"$context.requestId\\",\\"userAgent\\":\\"$context.identity.userAgent\\",\\"ip\\":\\"$context.identity.sourceIp\\",\\"requestTime\\":\\"$context.requestTime\\",\\"requestTimeEpoch\\":\\"$context.requestTimeEpoch\\",\\"dataProcessed\\":\\"$context.dataProcessed\\",\\"httpMethod\\":\\"$context.httpMethod\\",\\"path\\":\\"$context.path\\",\\"routeKey\\":\\"$context.routeKey\\",\\"status\\":\\"$context.status\\",\\"protocol\\":\\"$context.protocol\\",\\"responseLength\\":\\"$context.responseLength\\",\\"responseLatency\\":\\"$context.responseLatency\\",\\"domainName\\":\\"$context.domainName\\",\\"error\\":{\\"type\\":\\"$context.error.responseType\\",\\"gatewayError\\":\\"$context.error.message\\",\\"integrationError\\":\\"$context.integration.error\\",\\"authorizerError\\":\\"$context.authorizer.error\\"},\\"integration\\":{\\"latency\\":\\"$context.integration.latency\\",\\"requestId\\":\\"$context.integration.requestId\\",\\"responseStatus\\":\\"$context.integration.status\\"},\\"auth\\":{\\"iam\\":{\\"userArn\\":\\"$context.identity.userArn\\",\\"awsAccount\\":\\"$context.identity.accountId\\",\\"awsPrincipal\\":\\"$context.identity.caller\\",\\"awsPrincipalOrg\\":\\"$context.identity.principalOrgId\\"},\\"basic\\":{\\"user\\":\\"$context.authorizer.user\\"}},\\"awsEndpointRequest\\":{\\"id\\":\\"$context.awsEndpointRequestId\\",\\"id2\\":\\"$context.awsEndpointRequestId2\\"},\\"message\\":\\"$context.identity.sourceIp - $context.httpMethod $context.domainName $context.path ($context.routeKey) - $context.status [$context.responseLatency ms]\\"}",
        },
        "ApiId": Object {
          "Ref": "TestSqsApiGatewayHttpApimytestsqsapiBE5B3270",
        },
        "AutoDeploy": true,
        "DefaultRouteSettings": Object {
          "DetailedMetricsEnabled": true,
        },
        "StageName": "$default",
        "Tags": Object {
          "service": "my-test-sqs-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::Stage",
    },
    "TestSqsApiGatewayHttpApimytestsqsapiDefaultStageStackTestSqsApiGatewayCustomDomainDomainNamemytestsqsapiundefinedB412F3A8": Object {
      "DependsOn": Array [
        "TestSqsApiGatewayCustomDomainDomainNamemytestsqsapi0D7817A7",
        "TestSqsApiGatewayHttpApimytestsqsapiDefaultStageDF90C8F9",
      ],
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestSqsApiGatewayHttpApimytestsqsapiBE5B3270",
        },
        "DomainName": Object {
          "Ref": "TestSqsApiGatewayCustomDomainDomainNamemytestsqsapi0D7817A7",
        },
        "Stage": "$default",
      },
      "Type": "AWS::ApiGatewayV2::ApiMapping",
    },
    "TestSqsApiGatewayHttpApimytestsqsapiStackTestSqsApiGatewayHttpApimytestsqsapiDefaultAuthorizerCA5B7778Permission36473AD8": Object {
      "Properties": Object {
        "Action": "lambda:InvokeFunction",
        "FunctionName": Object {
          "Fn::GetAtt": Array [
            "TestSqsApiGatewayDefaultAuthorizerLambdaBasicAuthLambda7560641C",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:",
              Object {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-1:",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":",
              Object {
                "Ref": "TestSqsApiGatewayHttpApimytestsqsapiBE5B3270",
              },
              "/authorizers/",
              Object {
                "Ref": "TestSqsApiGatewayHttpApimytestsqsapiDefaultAuthorizerB4F89C21",
              },
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "TestSqsApiGatewayRouteapiqueueadd141125EE": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestSqsApiGatewayHttpApimytestsqsapiBE5B3270",
        },
        "AuthorizationType": "CUSTOM",
        "AuthorizerId": Object {
          "Ref": "TestSqsApiGatewayHttpApimytestsqsapiDefaultAuthorizerB4F89C21",
        },
        "RouteKey": "ANY /api/queue/add",
        "Target": Object {
          "Fn::Join": Array [
            "",
            Array [
              "integrations/",
              Object {
                "Ref": "TestSqsApiGatewayRouteapiqueueaddSqsIntegration4493A443",
              },
            ],
          ],
        },
      },
      "Type": "AWS::ApiGatewayV2::Route",
    },
    "TestSqsApiGatewayRouteapiqueueaddSqsIntegration4493A443": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestSqsApiGatewayHttpApimytestsqsapiBE5B3270",
        },
        "CredentialsArn": Object {
          "Fn::GetAtt": Array [
            "TestSqsApiGatewayApiGwToIngressQueueServiceRole1A7D8DD4",
            "Arn",
          ],
        },
        "IntegrationSubtype": "SQS-SendMessage",
        "IntegrationType": "AWS_PROXY",
        "PayloadFormatVersion": "1.0",
        "RequestParameters": Object {
          "MessageBody": "$request.body",
          "QueueUrl": Object {
            "Ref": "IngressQueue5DC71407",
          },
          "Region": "eu-west-1",
        },
      },
      "Type": "AWS::ApiGatewayV2::Integration",
    },
  },
}
`;

exports[`HTTP API Gateway creates API-GW HTTP API with Cognito User Pool authorizer 1`] = `
Object {
  "Resources": Object {
    "BasicAuthCredentialsSecretED3C53F8": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "Name": "/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials",
        "SecretString": "{\\"username\\":\\"test-user\\",\\"password\\":\\"test-password\\"}",
      },
      "Type": "AWS::SecretsManager::Secret",
      "UpdateReplacePolicy": "Delete",
    },
    "DnsARecordFED6ED67": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::Join": Array [
              "",
              Array [
                "dualstack.",
                Object {
                  "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancer8E47CE52DNSName59BE487A",
                },
              ],
            ],
          },
          "HostedZoneId": Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancer8E47CE52CanonicalHostedZoneID7C0E7DD7",
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-service-behind-alb.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "DnsListenerRule18B182CC": Object {
      "Properties": Object {
        "Actions": Array [
          Object {
            "TargetGroupArn": Object {
              "Ref": "ServiceTargetGroupE74A3394",
            },
            "Type": "forward",
          },
        ],
        "Conditions": Array [
          Object {
            "Field": "host-header",
            "HostHeaderConfig": Object {
              "Values": Array [
                "my-test-service-behind-alb.example.com",
              ],
            },
          },
        ],
        "ListenerArn": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefLoadBalancerHttpsListener68D81C9458BEEF85",
        },
        "Priority": 10,
      },
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
    },
    "Service9571FDD8": Object {
      "DependsOn": Array [
        "DnsListenerRule18B182CC",
        "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3",
        "ServiceTaskDefinitionTaskRole3BD32B0F",
      ],
      "Properties": Object {
        "Cluster": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefClusterEB0386A796A0E3FE",
        },
        "DeploymentConfiguration": Object {
          "Alarms": Object {
            "AlarmNames": Array [],
            "Enable": false,
            "Rollback": false,
          },
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
        },
        "DesiredCount": 2,
        "EnableECSManagedTags": false,
        "EnableExecuteCommand": true,
        "HealthCheckGracePeriodSeconds": 60,
        "LaunchType": "FARGATE",
        "LoadBalancers": Array [
          Object {
            "ContainerName": "Container",
            "ContainerPort": 8080,
            "TargetGroupArn": Object {
              "Ref": "ServiceTargetGroupE74A3394",
            },
          },
        ],
        "NetworkConfiguration": Object {
          "AwsvpcConfiguration": Object {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": Array [
              Object {
                "Fn::GetAtt": Array [
                  "ServiceSecurityGroupC96ED6A7",
                  "GroupId",
                ],
              },
            ],
            "Subnets": Array [
              Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPublicSubnet1Subnet5C2D37C4FFA2B456",
              },
              Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPublicSubnet2Subnet691E08A351552740",
              },
            ],
          },
        },
        "PlatformVersion": "1.4.0",
        "ServiceName": "example-service",
        "TaskDefinition": Object {
          "Ref": "ServiceTaskDefinition55FA0F15",
        },
      },
      "Type": "AWS::ECS::Service",
    },
    "ServiceLogGroupB910EE76": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 14,
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "ServiceSecurityGroupC96ED6A7": Object {
      "Properties": Object {
        "GroupDescription": "Stack/Service/SecurityGroup",
        "SecurityGroupEgress": Array [
          Object {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic by default",
            "IpProtocol": "-1",
          },
        ],
        "VpcId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefVpc8378EB38272D6E3A",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "ServiceSecurityGroupSupportStackLoadBalancerSecurityGroup0F63AB0C8080from36CDC9C8": Object {
      "Properties": Object {
        "Description": "Load balancer to target",
        "DestinationSecurityGroupId": Object {
          "Fn::GetAtt": Array [
            "ServiceSecurityGroupC96ED6A7",
            "GroupId",
          ],
        },
        "FromPort": 8080,
        "GroupId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
        },
        "IpProtocol": "tcp",
        "ToPort": 8080,
      },
      "Type": "AWS::EC2::SecurityGroupEgress",
    },
    "ServiceSecurityGroupfromSupportStackLoadBalancerSecurityGroup0F63AB0C80803CEA72C3": Object {
      "Properties": Object {
        "Description": "Load balancer to target",
        "FromPort": 8080,
        "GroupId": Object {
          "Fn::GetAtt": Array [
            "ServiceSecurityGroupC96ED6A7",
            "GroupId",
          ],
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
        },
        "ToPort": 8080,
      },
      "Type": "AWS::EC2::SecurityGroupIngress",
    },
    "ServiceTargetGroupE74A3394": Object {
      "Properties": Object {
        "HealthCheckIntervalSeconds": 10,
        "HealthCheckPath": "/health",
        "HealthyThresholdCount": 2,
        "Port": 8080,
        "Protocol": "HTTP",
        "TargetGroupAttributes": Array [
          Object {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "15",
          },
          Object {
            "Key": "stickiness.enabled",
            "Value": "false",
          },
        ],
        "TargetType": "ip",
        "VpcId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefVpc8378EB38272D6E3A",
        },
      },
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
    },
    "ServiceTaskDefinition55FA0F15": Object {
      "Properties": Object {
        "ContainerDefinitions": Array [
          Object {
            "Environment": Array [
              Object {
                "Name": "SSM_PREFIX",
                "Value": "/liflig-cdk/Stack/c8cabff989df74f9b2755f4ae923cc6492f944970b/parameters",
              },
              Object {
                "Name": "PARAMS_HASH",
                "Value": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
              },
            ],
            "Essential": true,
            "Image": Object {
              "Fn::Join": Array [
                "",
                Array [
                  Object {
                    "Fn::Select": Array [
                      4,
                      Object {
                        "Fn::Split": Array [
                          ":",
                          Object {
                            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
                          },
                        ],
                      },
                    ],
                  },
                  ".dkr.ecr.",
                  Object {
                    "Fn::Select": Array [
                      3,
                      Object {
                        "Fn::Split": Array [
                          ":",
                          Object {
                            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
                          },
                        ],
                      },
                    ],
                  },
                  ".",
                  Object {
                    "Ref": "AWS::URLSuffix",
                  },
                  "/",
                  Object {
                    "Fn::ImportValue": "SupportStack:ExportsOutputRefRepository22E53BBD9A9E013B",
                  },
                  ":exampleEcrTag",
                ],
              ],
            },
            "LinuxParameters": Object {
              "Capabilities": Object {},
              "InitProcessEnabled": true,
            },
            "LogConfiguration": Object {
              "LogDriver": "awslogs",
              "Options": Object {
                "awslogs-datetime-format": "%Y-%m-%dT%H:%M:%S",
                "awslogs-group": Object {
                  "Ref": "ServiceLogGroupB910EE76",
                },
                "awslogs-region": "eu-west-1",
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "Container",
            "PortMappings": Array [
              Object {
                "ContainerPort": 8080,
                "HostPort": 8080,
                "Protocol": "tcp",
              },
            ],
          },
        ],
        "Cpu": "256",
        "ExecutionRoleArn": Object {
          "Fn::GetAtt": Array [
            "ServiceTaskDefinitionExecutionRole5D3DB197",
            "Arn",
          ],
        },
        "Family": "StackServiceTaskDefinition81B5CCD5",
        "Memory": "512",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": Array [
          "FARGATE",
        ],
        "TaskRoleArn": Object {
          "Fn::GetAtt": Array [
            "ServiceTaskDefinitionTaskRole3BD32B0F",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "ServiceTaskDefinitionExecutionRole5D3DB197": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ServiceTaskDefinitionExecutionRoleDefaultPolicyE16C69DE": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
              },
            },
            Object {
              "Action": "ecr:GetAuthorizationToken",
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "ServiceLogGroupB910EE76",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ServiceTaskDefinitionExecutionRoleDefaultPolicyE16C69DE",
        "Roles": Array [
          Object {
            "Ref": "ServiceTaskDefinitionExecutionRole5D3DB197",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "ServiceTaskDefinitionTaskRole3BD32B0F": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    "arn:aws:ssm:eu-west-1:",
                    Object {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/liflig-cdk/Stack/c8cabff989df74f9b2755f4ae923cc6492f944970b/parameters/*",
                  ],
                ],
              },
            },
            Object {
              "Action": Array [
                "ssmmessages:CreateControlChannel",
                "ssmmessages:CreateDataChannel",
                "ssmmessages:OpenControlChannel",
                "ssmmessages:OpenDataChannel",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": "logs:DescribeLogGroups",
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3",
        "Roles": Array [
          Object {
            "Ref": "ServiceTaskDefinitionTaskRole3BD32B0F",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAccessLogsAccessLogGroup4174FE48": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 180,
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-auth",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRole6EFEC430": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-auth",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyFDE58B7C": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "TestApiGatewayWithCognitoUserPoolAuthAccessLogsAccessLogGroup4174FE48",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyFDE58B7C",
        "Roles": Array [
          Object {
            "Ref": "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRole6EFEC430",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAlbVpcLink985E4A83": Object {
      "Properties": Object {
        "Name": "StackTestApiGatewayWithCognitoUserPoolAuthAlbVpcLink2EFF2C60",
        "SecurityGroupIds": Array [
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
          },
        ],
        "SubnetIds": Array [
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet1Subnet536B997AFD4CC940",
          },
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet2Subnet3788AAA1380949A3",
          },
        ],
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::VpcLink",
    },
    "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolauthF5D2D5FA": Object {
      "Properties": Object {
        "DomainName": "my-test-api-with-cognito-user-pool-auth.example.com",
        "DomainNameConfigurations": Array [
          Object {
            "CertificateArn": Object {
              "Ref": "TestApiGatewayWithCognitoUserPoolAuthCustomDomainHttpsCertificate812CE797",
            },
            "EndpointType": "REGIONAL",
            "SecurityPolicy": "TLS_1_2",
          },
        ],
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::DomainName",
    },
    "TestApiGatewayWithCognitoUserPoolAuthCustomDomainHttpsCertificate812CE797": Object {
      "Properties": Object {
        "DomainName": "my-test-api-with-cognito-user-pool-auth.example.com",
        "DomainValidationOptions": Array [
          Object {
            "DomainName": "my-test-api-with-cognito-user-pool-auth.example.com",
            "HostedZoneId": Object {
              "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
            },
          },
        ],
        "Tags": Array [
          Object {
            "Key": "Name",
            "Value": "Stack/TestApiGatewayWithCognitoUserPoolAuth/CustomDomain/HttpsCertificate",
          },
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-auth",
          },
        ],
        "ValidationMethod": "DNS",
      },
      "Type": "AWS::CertificateManager::Certificate",
    },
    "TestApiGatewayWithCognitoUserPoolAuthCustomDomainRoute53ARecordApigwAlias0EA12A84": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::GetAtt": Array [
              "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolauthF5D2D5FA",
              "RegionalDomainName",
            ],
          },
          "HostedZoneId": Object {
            "Fn::GetAtt": Array [
              "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolauthF5D2D5FA",
              "RegionalHostedZoneId",
            ],
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-api-with-cognito-user-pool-auth.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunction7B0C8FC5": Object {
      "DependsOn": Array [
        "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleDefaultPolicy02CDDB33",
        "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58",
      ],
      "Properties": Object {
        "Code": Object {
          "S3Bucket": Object {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-1",
          },
          "S3Key": "f32a280b8c8d745b8eb16fa89f8170152d407c4e6c13947fb9744f71eb2847a7.zip",
        },
        "Environment": Object {
          "Variables": Object {
            "CREDENTIALS_FOR_INTERNAL_AUTHORIZATION": "/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials",
            "REQUIRED_SCOPE": "example/read_users",
            "USER_POOL_ID": Object {
              "Ref": "UserPool6BA7E5F2",
            },
          },
        },
        "Handler": "index.handler",
        "Role": Object {
          "Fn::GetAtt": Array [
            "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-auth",
          },
        ],
        "Timeout": 5,
      },
      "Type": "AWS::Lambda::Function",
    },
    "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleDefaultPolicy02CDDB33": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    "arn:",
                    Object {
                      "Ref": "AWS::Partition",
                    },
                    ":secretsmanager:eu-west-1:",
                    Object {
                      "Ref": "AWS::AccountId",
                    },
                    ":secret:/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials-??????",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleDefaultPolicy02CDDB33",
        "Roles": Array [
          Object {
            "Ref": "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-auth",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthA800E05B": Object {
      "Properties": Object {
        "Description": "An HTTP API for my-test-api-with-cognito-user-pool-auth.example.com.",
        "DisableExecuteApiEndpoint": true,
        "Name": "HttpApi-my-test-api-with-cognito-user-pool-auth",
        "ProtocolType": "HTTP",
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::Api",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthDefaultAuthorizer743AE3D0": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthA800E05B",
        },
        "AuthorizerPayloadFormatVersion": "2.0",
        "AuthorizerResultTtlInSeconds": 3600,
        "AuthorizerType": "REQUEST",
        "AuthorizerUri": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:",
              Object {
                "Ref": "AWS::Partition",
              },
              ":apigateway:eu-west-1:lambda:path/2015-03-31/functions/",
              Object {
                "Fn::GetAtt": Array [
                  "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunction7B0C8FC5",
                  "Arn",
                ],
              },
              "/invocations",
            ],
          ],
        },
        "EnableSimpleResponses": true,
        "IdentitySource": Array [
          "$request.header.Authorization",
        ],
        "Name": "DefaultAuthorizer",
      },
      "Type": "AWS::ApiGatewayV2::Authorizer",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthDefaultStage12E26841": Object {
      "DependsOn": Array [
        "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolauthF5D2D5FA",
      ],
      "Properties": Object {
        "AccessLogSettings": Object {
          "DestinationArn": Object {
            "Fn::GetAtt": Array [
              "TestApiGatewayWithCognitoUserPoolAuthAccessLogsAccessLogGroup4174FE48",
              "Arn",
            ],
          },
          "Format": "{\\"requestId\\":\\"$context.requestId\\",\\"userAgent\\":\\"$context.identity.userAgent\\",\\"ip\\":\\"$context.identity.sourceIp\\",\\"requestTime\\":\\"$context.requestTime\\",\\"requestTimeEpoch\\":\\"$context.requestTimeEpoch\\",\\"dataProcessed\\":\\"$context.dataProcessed\\",\\"httpMethod\\":\\"$context.httpMethod\\",\\"path\\":\\"$context.path\\",\\"routeKey\\":\\"$context.routeKey\\",\\"status\\":\\"$context.status\\",\\"protocol\\":\\"$context.protocol\\",\\"responseLength\\":\\"$context.responseLength\\",\\"responseLatency\\":\\"$context.responseLatency\\",\\"domainName\\":\\"$context.domainName\\",\\"error\\":{\\"type\\":\\"$context.error.responseType\\",\\"gatewayError\\":\\"$context.error.message\\",\\"integrationError\\":\\"$context.integration.error\\",\\"authorizerError\\":\\"$context.authorizer.error\\"},\\"integration\\":{\\"latency\\":\\"$context.integration.latency\\",\\"requestId\\":\\"$context.integration.requestId\\",\\"responseStatus\\":\\"$context.integration.status\\"},\\"auth\\":{\\"iam\\":{\\"userArn\\":\\"$context.identity.userArn\\",\\"awsAccount\\":\\"$context.identity.accountId\\",\\"awsPrincipal\\":\\"$context.identity.caller\\",\\"awsPrincipalOrg\\":\\"$context.identity.principalOrgId\\"},\\"basic\\":{\\"user\\":\\"$context.authorizer.user\\"}},\\"awsEndpointRequest\\":{\\"id\\":\\"$context.awsEndpointRequestId\\",\\"id2\\":\\"$context.awsEndpointRequestId2\\"},\\"message\\":\\"$context.identity.sourceIp - $context.httpMethod $context.domainName $context.path ($context.routeKey) - $context.status [$context.responseLatency ms]\\"}",
        },
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthA800E05B",
        },
        "AutoDeploy": true,
        "DefaultRouteSettings": Object {
          "DetailedMetricsEnabled": true,
        },
        "StageName": "$default",
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::Stage",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthDefaultStageStackTestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolauthundefinedCC3D8B3B": Object {
      "DependsOn": Array [
        "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolauthF5D2D5FA",
        "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthDefaultStage12E26841",
      ],
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthA800E05B",
        },
        "DomainName": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolauthF5D2D5FA",
        },
        "Stage": "$default",
      },
      "Type": "AWS::ApiGatewayV2::ApiMapping",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthStackTestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthDefaultAuthorizerBE5F2EF0PermissionB03364AA": Object {
      "Properties": Object {
        "Action": "lambda:InvokeFunction",
        "FunctionName": Object {
          "Fn::GetAtt": Array [
            "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunction7B0C8FC5",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:",
              Object {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-1:",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":",
              Object {
                "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthA800E05B",
              },
              "/authorizers/",
              Object {
                "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthDefaultAuthorizer743AE3D0",
              },
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "TestApiGatewayWithCognitoUserPoolAuthRouteapiAlbIntegrationmytestapiwithcognitouserpoolauth842EF02A": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthA800E05B",
        },
        "ConnectionId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthAlbVpcLink985E4A83",
        },
        "ConnectionType": "VPC_LINK",
        "IntegrationMethod": "ANY",
        "IntegrationType": "HTTP_PROXY",
        "IntegrationUri": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefLoadBalancerHttpsListener68D81C9458BEEF85",
        },
        "PayloadFormatVersion": "1.0",
        "RequestParameters": Object {
          "overwrite:header.Host": "my-test-service-behind-alb.example.com",
        },
        "TlsConfig": Object {
          "ServerNameToVerify": "my-test-service-behind-alb.example.com",
        },
      },
      "Type": "AWS::ApiGatewayV2::Integration",
    },
    "TestApiGatewayWithCognitoUserPoolAuthRouteapiF0960F71": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthA800E05B",
        },
        "AuthorizationType": "CUSTOM",
        "AuthorizerId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolauthDefaultAuthorizer743AE3D0",
        },
        "RouteKey": "ANY /api",
        "Target": Object {
          "Fn::Join": Array [
            "",
            Array [
              "integrations/",
              Object {
                "Ref": "TestApiGatewayWithCognitoUserPoolAuthRouteapiAlbIntegrationmytestapiwithcognitouserpoolauth842EF02A",
              },
            ],
          ],
        },
      },
      "Type": "AWS::ApiGatewayV2::Route",
    },
    "UserPool6BA7E5F2": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "AccountRecoverySetting": Object {
          "RecoveryMechanisms": Array [
            Object {
              "Name": "verified_phone_number",
              "Priority": 1,
            },
            Object {
              "Name": "verified_email",
              "Priority": 2,
            },
          ],
        },
        "AdminCreateUserConfig": Object {
          "AllowAdminCreateUserOnly": true,
        },
        "EmailVerificationMessage": "The verification code to your new account is {####}",
        "EmailVerificationSubject": "Verify your new account",
        "SmsVerificationMessage": "The verification code to your new account is {####}",
        "VerificationMessageTemplate": Object {
          "DefaultEmailOption": "CONFIRM_WITH_CODE",
          "EmailMessage": "The verification code to your new account is {####}",
          "EmailSubject": "Verify your new account",
          "SmsMessage": "The verification code to your new account is {####}",
        },
      },
      "Type": "AWS::Cognito::UserPool",
      "UpdateReplacePolicy": "Retain",
    },
  },
}
`;

exports[`HTTP API Gateway creates API-GW HTTP API with Cognito User Pool/Basic Auth authorizer 1`] = `
Object {
  "Resources": Object {
    "BasicAuthCredentialsSecretED3C53F8": Object {
      "DeletionPolicy": "Delete",
      "Properties": Object {
        "Name": "/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials",
        "SecretString": "{\\"username\\":\\"test-user\\",\\"password\\":\\"test-password\\"}",
      },
      "Type": "AWS::SecretsManager::Secret",
      "UpdateReplacePolicy": "Delete",
    },
    "DnsARecordFED6ED67": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::Join": Array [
              "",
              Array [
                "dualstack.",
                Object {
                  "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancer8E47CE52DNSName59BE487A",
                },
              ],
            ],
          },
          "HostedZoneId": Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancer8E47CE52CanonicalHostedZoneID7C0E7DD7",
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-service-behind-alb.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "DnsListenerRule18B182CC": Object {
      "Properties": Object {
        "Actions": Array [
          Object {
            "TargetGroupArn": Object {
              "Ref": "ServiceTargetGroupE74A3394",
            },
            "Type": "forward",
          },
        ],
        "Conditions": Array [
          Object {
            "Field": "host-header",
            "HostHeaderConfig": Object {
              "Values": Array [
                "my-test-service-behind-alb.example.com",
              ],
            },
          },
        ],
        "ListenerArn": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefLoadBalancerHttpsListener68D81C9458BEEF85",
        },
        "Priority": 10,
      },
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
    },
    "Service9571FDD8": Object {
      "DependsOn": Array [
        "DnsListenerRule18B182CC",
        "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3",
        "ServiceTaskDefinitionTaskRole3BD32B0F",
      ],
      "Properties": Object {
        "Cluster": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefClusterEB0386A796A0E3FE",
        },
        "DeploymentConfiguration": Object {
          "Alarms": Object {
            "AlarmNames": Array [],
            "Enable": false,
            "Rollback": false,
          },
          "MaximumPercent": 200,
          "MinimumHealthyPercent": 100,
        },
        "DesiredCount": 2,
        "EnableECSManagedTags": false,
        "EnableExecuteCommand": true,
        "HealthCheckGracePeriodSeconds": 60,
        "LaunchType": "FARGATE",
        "LoadBalancers": Array [
          Object {
            "ContainerName": "Container",
            "ContainerPort": 8080,
            "TargetGroupArn": Object {
              "Ref": "ServiceTargetGroupE74A3394",
            },
          },
        ],
        "NetworkConfiguration": Object {
          "AwsvpcConfiguration": Object {
            "AssignPublicIp": "ENABLED",
            "SecurityGroups": Array [
              Object {
                "Fn::GetAtt": Array [
                  "ServiceSecurityGroupC96ED6A7",
                  "GroupId",
                ],
              },
            ],
            "Subnets": Array [
              Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPublicSubnet1Subnet5C2D37C4FFA2B456",
              },
              Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPublicSubnet2Subnet691E08A351552740",
              },
            ],
          },
        },
        "PlatformVersion": "1.4.0",
        "ServiceName": "example-service",
        "TaskDefinition": Object {
          "Ref": "ServiceTaskDefinition55FA0F15",
        },
      },
      "Type": "AWS::ECS::Service",
    },
    "ServiceLogGroupB910EE76": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 14,
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "ServiceSecurityGroupC96ED6A7": Object {
      "Properties": Object {
        "GroupDescription": "Stack/Service/SecurityGroup",
        "SecurityGroupEgress": Array [
          Object {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic by default",
            "IpProtocol": "-1",
          },
        ],
        "VpcId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefVpc8378EB38272D6E3A",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "ServiceSecurityGroupSupportStackLoadBalancerSecurityGroup0F63AB0C8080from36CDC9C8": Object {
      "Properties": Object {
        "Description": "Load balancer to target",
        "DestinationSecurityGroupId": Object {
          "Fn::GetAtt": Array [
            "ServiceSecurityGroupC96ED6A7",
            "GroupId",
          ],
        },
        "FromPort": 8080,
        "GroupId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
        },
        "IpProtocol": "tcp",
        "ToPort": 8080,
      },
      "Type": "AWS::EC2::SecurityGroupEgress",
    },
    "ServiceSecurityGroupfromSupportStackLoadBalancerSecurityGroup0F63AB0C80803CEA72C3": Object {
      "Properties": Object {
        "Description": "Load balancer to target",
        "FromPort": 8080,
        "GroupId": Object {
          "Fn::GetAtt": Array [
            "ServiceSecurityGroupC96ED6A7",
            "GroupId",
          ],
        },
        "IpProtocol": "tcp",
        "SourceSecurityGroupId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
        },
        "ToPort": 8080,
      },
      "Type": "AWS::EC2::SecurityGroupIngress",
    },
    "ServiceTargetGroupE74A3394": Object {
      "Properties": Object {
        "HealthCheckIntervalSeconds": 10,
        "HealthCheckPath": "/health",
        "HealthyThresholdCount": 2,
        "Port": 8080,
        "Protocol": "HTTP",
        "TargetGroupAttributes": Array [
          Object {
            "Key": "deregistration_delay.timeout_seconds",
            "Value": "15",
          },
          Object {
            "Key": "stickiness.enabled",
            "Value": "false",
          },
        ],
        "TargetType": "ip",
        "VpcId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefVpc8378EB38272D6E3A",
        },
      },
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
    },
    "ServiceTaskDefinition55FA0F15": Object {
      "Properties": Object {
        "ContainerDefinitions": Array [
          Object {
            "Environment": Array [
              Object {
                "Name": "SSM_PREFIX",
                "Value": "/liflig-cdk/Stack/c8cabff989df74f9b2755f4ae923cc6492f944970b/parameters",
              },
              Object {
                "Name": "PARAMS_HASH",
                "Value": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
              },
            ],
            "Essential": true,
            "Image": Object {
              "Fn::Join": Array [
                "",
                Array [
                  Object {
                    "Fn::Select": Array [
                      4,
                      Object {
                        "Fn::Split": Array [
                          ":",
                          Object {
                            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
                          },
                        ],
                      },
                    ],
                  },
                  ".dkr.ecr.",
                  Object {
                    "Fn::Select": Array [
                      3,
                      Object {
                        "Fn::Split": Array [
                          ":",
                          Object {
                            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
                          },
                        ],
                      },
                    ],
                  },
                  ".",
                  Object {
                    "Ref": "AWS::URLSuffix",
                  },
                  "/",
                  Object {
                    "Fn::ImportValue": "SupportStack:ExportsOutputRefRepository22E53BBD9A9E013B",
                  },
                  ":exampleEcrTag",
                ],
              ],
            },
            "LinuxParameters": Object {
              "Capabilities": Object {},
              "InitProcessEnabled": true,
            },
            "LogConfiguration": Object {
              "LogDriver": "awslogs",
              "Options": Object {
                "awslogs-datetime-format": "%Y-%m-%dT%H:%M:%S",
                "awslogs-group": Object {
                  "Ref": "ServiceLogGroupB910EE76",
                },
                "awslogs-region": "eu-west-1",
                "awslogs-stream-prefix": "ecs",
              },
            },
            "Name": "Container",
            "PortMappings": Array [
              Object {
                "ContainerPort": 8080,
                "HostPort": 8080,
                "Protocol": "tcp",
              },
            ],
          },
        ],
        "Cpu": "256",
        "ExecutionRoleArn": Object {
          "Fn::GetAtt": Array [
            "ServiceTaskDefinitionExecutionRole5D3DB197",
            "Arn",
          ],
        },
        "Family": "StackServiceTaskDefinition81B5CCD5",
        "Memory": "512",
        "NetworkMode": "awsvpc",
        "RequiresCompatibilities": Array [
          "FARGATE",
        ],
        "TaskRoleArn": Object {
          "Fn::GetAtt": Array [
            "ServiceTaskDefinitionTaskRole3BD32B0F",
            "Arn",
          ],
        },
      },
      "Type": "AWS::ECS::TaskDefinition",
    },
    "ServiceTaskDefinitionExecutionRole5D3DB197": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ServiceTaskDefinitionExecutionRoleDefaultPolicyE16C69DE": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttRepository22E53BBDArn3AD4E30B",
              },
            },
            Object {
              "Action": "ecr:GetAuthorizationToken",
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "ServiceLogGroupB910EE76",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ServiceTaskDefinitionExecutionRoleDefaultPolicyE16C69DE",
        "Roles": Array [
          Object {
            "Ref": "ServiceTaskDefinitionExecutionRole5D3DB197",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "ServiceTaskDefinitionTaskRole3BD32B0F": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "ecs-tasks.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
      },
      "Type": "AWS::IAM::Role",
    },
    "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    "arn:aws:ssm:eu-west-1:",
                    Object {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/liflig-cdk/Stack/c8cabff989df74f9b2755f4ae923cc6492f944970b/parameters/*",
                  ],
                ],
              },
            },
            Object {
              "Action": Array [
                "ssmmessages:CreateControlChannel",
                "ssmmessages:CreateDataChannel",
                "ssmmessages:OpenControlChannel",
                "ssmmessages:OpenDataChannel",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": "logs:DescribeLogGroups",
              "Effect": "Allow",
              "Resource": "*",
            },
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:DescribeLogStreams",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "ServiceTaskDefinitionTaskRoleDefaultPolicyED991BA3",
        "Roles": Array [
          Object {
            "Ref": "ServiceTaskDefinitionTaskRole3BD32B0F",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAccessLogsAccessLogGroup4174FE48": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 180,
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-or-basic-auth",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRole6EFEC430": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-or-basic-auth",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyFDE58B7C": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "TestApiGatewayWithCognitoUserPoolAuthAccessLogsAccessLogGroup4174FE48",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyFDE58B7C",
        "Roles": Array [
          Object {
            "Ref": "TestApiGatewayWithCognitoUserPoolAuthAccessLogsApiGatewayPushToCloudwatchLogsRole6EFEC430",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestApiGatewayWithCognitoUserPoolAuthAlbVpcLink985E4A83": Object {
      "Properties": Object {
        "Name": "StackTestApiGatewayWithCognitoUserPoolAuthAlbVpcLink2EFF2C60",
        "SecurityGroupIds": Array [
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputFnGetAttLoadBalancerSecurityGroup3036A0FCGroupId98A51D63",
          },
        ],
        "SubnetIds": Array [
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet1Subnet536B997AFD4CC940",
          },
          Object {
            "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet2Subnet3788AAA1380949A3",
          },
        ],
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-or-basic-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::VpcLink",
    },
    "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolorbasicauth5EB12B02": Object {
      "Properties": Object {
        "DomainName": "my-test-api-with-cognito-user-pool-or-basic-auth.example.com",
        "DomainNameConfigurations": Array [
          Object {
            "CertificateArn": Object {
              "Ref": "TestApiGatewayWithCognitoUserPoolAuthCustomDomainHttpsCertificate812CE797",
            },
            "EndpointType": "REGIONAL",
            "SecurityPolicy": "TLS_1_2",
          },
        ],
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-or-basic-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::DomainName",
    },
    "TestApiGatewayWithCognitoUserPoolAuthCustomDomainHttpsCertificate812CE797": Object {
      "Properties": Object {
        "DomainName": "my-test-api-with-cognito-user-pool-or-basic-auth.example.com",
        "DomainValidationOptions": Array [
          Object {
            "DomainName": "my-test-api-with-cognito-user-pool-or-basic-auth.example.com",
            "HostedZoneId": Object {
              "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
            },
          },
        ],
        "Tags": Array [
          Object {
            "Key": "Name",
            "Value": "Stack/TestApiGatewayWithCognitoUserPoolAuth/CustomDomain/HttpsCertificate",
          },
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-or-basic-auth",
          },
        ],
        "ValidationMethod": "DNS",
      },
      "Type": "AWS::CertificateManager::Certificate",
    },
    "TestApiGatewayWithCognitoUserPoolAuthCustomDomainRoute53ARecordApigwAlias0EA12A84": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::GetAtt": Array [
              "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolorbasicauth5EB12B02",
              "RegionalDomainName",
            ],
          },
          "HostedZoneId": Object {
            "Fn::GetAtt": Array [
              "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolorbasicauth5EB12B02",
              "RegionalHostedZoneId",
            ],
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-api-with-cognito-user-pool-or-basic-auth.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunction7B0C8FC5": Object {
      "DependsOn": Array [
        "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleDefaultPolicy02CDDB33",
        "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58",
      ],
      "Properties": Object {
        "Code": Object {
          "S3Bucket": Object {
            "Fn::Sub": "cdk-hnb659fds-assets-\${AWS::AccountId}-eu-west-1",
          },
          "S3Key": "358ca55a079ce8e652fcbad2dec2364f9e744c5cdd01576061a6026c4cbc18e4.zip",
        },
        "Environment": Object {
          "Variables": Object {
            "BASIC_AUTH_CREDENTIALS_SECRET_NAME": "/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials",
            "REQUIRED_SCOPE": "example/read_users",
            "USER_POOL_ID": Object {
              "Ref": "UserPool6BA7E5F2",
            },
          },
        },
        "Handler": "index.handler",
        "Role": Object {
          "Fn::GetAtt": Array [
            "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-or-basic-auth",
          },
        ],
        "Timeout": 5,
      },
      "Type": "AWS::Lambda::Function",
    },
    "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleDefaultPolicy02CDDB33": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::Join": Array [
                  "",
                  Array [
                    "arn:",
                    Object {
                      "Ref": "AWS::Partition",
                    },
                    ":secretsmanager:eu-west-1:",
                    Object {
                      "Ref": "AWS::AccountId",
                    },
                    ":secret:/example/cdk/prod/myService/myservice.gateway.auth.basic.credentials-??????",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleDefaultPolicy02CDDB33",
        "Roles": Array [
          Object {
            "Ref": "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunctionServiceRoleE6C8ED58": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-api-with-cognito-user-pool-or-basic-auth",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauth873A1284": Object {
      "Properties": Object {
        "Description": "An HTTP API for my-test-api-with-cognito-user-pool-or-basic-auth.example.com.",
        "DisableExecuteApiEndpoint": true,
        "Name": "HttpApi-my-test-api-with-cognito-user-pool-or-basic-auth",
        "ProtocolType": "HTTP",
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-or-basic-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::Api",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthDefaultAuthorizerD8C90E76": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauth873A1284",
        },
        "AuthorizerPayloadFormatVersion": "2.0",
        "AuthorizerResultTtlInSeconds": 3600,
        "AuthorizerType": "REQUEST",
        "AuthorizerUri": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:",
              Object {
                "Ref": "AWS::Partition",
              },
              ":apigateway:eu-west-1:lambda:path/2015-03-31/functions/",
              Object {
                "Fn::GetAtt": Array [
                  "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunction7B0C8FC5",
                  "Arn",
                ],
              },
              "/invocations",
            ],
          ],
        },
        "EnableSimpleResponses": true,
        "IdentitySource": Array [
          "$request.header.Authorization",
        ],
        "Name": "DefaultAuthorizer",
      },
      "Type": "AWS::ApiGatewayV2::Authorizer",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthDefaultStage62DF3C4D": Object {
      "DependsOn": Array [
        "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolorbasicauth5EB12B02",
      ],
      "Properties": Object {
        "AccessLogSettings": Object {
          "DestinationArn": Object {
            "Fn::GetAtt": Array [
              "TestApiGatewayWithCognitoUserPoolAuthAccessLogsAccessLogGroup4174FE48",
              "Arn",
            ],
          },
          "Format": "{\\"requestId\\":\\"$context.requestId\\",\\"userAgent\\":\\"$context.identity.userAgent\\",\\"ip\\":\\"$context.identity.sourceIp\\",\\"requestTime\\":\\"$context.requestTime\\",\\"requestTimeEpoch\\":\\"$context.requestTimeEpoch\\",\\"dataProcessed\\":\\"$context.dataProcessed\\",\\"httpMethod\\":\\"$context.httpMethod\\",\\"path\\":\\"$context.path\\",\\"routeKey\\":\\"$context.routeKey\\",\\"status\\":\\"$context.status\\",\\"protocol\\":\\"$context.protocol\\",\\"responseLength\\":\\"$context.responseLength\\",\\"responseLatency\\":\\"$context.responseLatency\\",\\"domainName\\":\\"$context.domainName\\",\\"error\\":{\\"type\\":\\"$context.error.responseType\\",\\"gatewayError\\":\\"$context.error.message\\",\\"integrationError\\":\\"$context.integration.error\\",\\"authorizerError\\":\\"$context.authorizer.error\\"},\\"integration\\":{\\"latency\\":\\"$context.integration.latency\\",\\"requestId\\":\\"$context.integration.requestId\\",\\"responseStatus\\":\\"$context.integration.status\\"},\\"auth\\":{\\"iam\\":{\\"userArn\\":\\"$context.identity.userArn\\",\\"awsAccount\\":\\"$context.identity.accountId\\",\\"awsPrincipal\\":\\"$context.identity.caller\\",\\"awsPrincipalOrg\\":\\"$context.identity.principalOrgId\\"},\\"basic\\":{\\"user\\":\\"$context.authorizer.user\\"}},\\"awsEndpointRequest\\":{\\"id\\":\\"$context.awsEndpointRequestId\\",\\"id2\\":\\"$context.awsEndpointRequestId2\\"},\\"message\\":\\"$context.identity.sourceIp - $context.httpMethod $context.domainName $context.path ($context.routeKey) - $context.status [$context.responseLatency ms]\\"}",
        },
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauth873A1284",
        },
        "AutoDeploy": true,
        "DefaultRouteSettings": Object {
          "DetailedMetricsEnabled": true,
        },
        "StageName": "$default",
        "Tags": Object {
          "service": "my-test-api-with-cognito-user-pool-or-basic-auth",
        },
      },
      "Type": "AWS::ApiGatewayV2::Stage",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthDefaultStageStackTestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolorbasicauthundefinedC30D22CB": Object {
      "DependsOn": Array [
        "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolorbasicauth5EB12B02",
        "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthDefaultStage62DF3C4D",
      ],
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauth873A1284",
        },
        "DomainName": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthCustomDomainDomainNamemytestapiwithcognitouserpoolorbasicauth5EB12B02",
        },
        "Stage": "$default",
      },
      "Type": "AWS::ApiGatewayV2::ApiMapping",
    },
    "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthStackTestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthDefaultAuthorizerC9A20EE9Permission0EF38AA1": Object {
      "Properties": Object {
        "Action": "lambda:InvokeFunction",
        "FunctionName": Object {
          "Fn::GetAtt": Array [
            "TestApiGatewayWithCognitoUserPoolAuthDefaultAuthorizerLambdaAuthorizerFunction7B0C8FC5",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:",
              Object {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-1:",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":",
              Object {
                "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauth873A1284",
              },
              "/authorizers/",
              Object {
                "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthDefaultAuthorizerD8C90E76",
              },
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
    "TestApiGatewayWithCognitoUserPoolAuthRouteapiAlbIntegrationmytestapiwithcognitouserpoolorbasicauthC4CF73D6": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauth873A1284",
        },
        "ConnectionId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthAlbVpcLink985E4A83",
        },
        "ConnectionType": "VPC_LINK",
        "IntegrationMethod": "ANY",
        "IntegrationType": "HTTP_PROXY",
        "IntegrationUri": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefLoadBalancerHttpsListener68D81C9458BEEF85",
        },
        "PayloadFormatVersion": "1.0",
        "RequestParameters": Object {
          "overwrite:header.Host": "my-test-service-behind-alb.example.com",
        },
        "TlsConfig": Object {
          "ServerNameToVerify": "my-test-service-behind-alb.example.com",
        },
      },
      "Type": "AWS::ApiGatewayV2::Integration",
    },
    "TestApiGatewayWithCognitoUserPoolAuthRouteapiF0960F71": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauth873A1284",
        },
        "AuthorizationType": "CUSTOM",
        "AuthorizerId": Object {
          "Ref": "TestApiGatewayWithCognitoUserPoolAuthHttpApimytestapiwithcognitouserpoolorbasicauthDefaultAuthorizerD8C90E76",
        },
        "RouteKey": "ANY /api",
        "Target": Object {
          "Fn::Join": Array [
            "",
            Array [
              "integrations/",
              Object {
                "Ref": "TestApiGatewayWithCognitoUserPoolAuthRouteapiAlbIntegrationmytestapiwithcognitouserpoolorbasicauthC4CF73D6",
              },
            ],
          ],
        },
      },
      "Type": "AWS::ApiGatewayV2::Route",
    },
    "UserPool6BA7E5F2": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "AccountRecoverySetting": Object {
          "RecoveryMechanisms": Array [
            Object {
              "Name": "verified_phone_number",
              "Priority": 1,
            },
            Object {
              "Name": "verified_email",
              "Priority": 2,
            },
          ],
        },
        "AdminCreateUserConfig": Object {
          "AllowAdminCreateUserOnly": true,
        },
        "EmailVerificationMessage": "The verification code to your new account is {####}",
        "EmailVerificationSubject": "Verify your new account",
        "SmsVerificationMessage": "The verification code to your new account is {####}",
        "VerificationMessageTemplate": Object {
          "DefaultEmailOption": "CONFIRM_WITH_CODE",
          "EmailMessage": "The verification code to your new account is {####}",
          "EmailSubject": "Verify your new account",
          "SmsMessage": "The verification code to your new account is {####}",
        },
      },
      "Type": "AWS::Cognito::UserPool",
      "UpdateReplacePolicy": "Retain",
    },
  },
}
`;

exports[`HTTP API Gateway creates API-GW HTTP API with no auth and Lambda integration 1`] = `
Object {
  "Resources": Object {
    "MyApiLambdaF4205182": Object {
      "DependsOn": Array [
        "MyApiLambdaServiceRoleCD73D6D7",
      ],
      "Properties": Object {
        "Code": Object {
          "ZipFile": "exports.handler = async(event) => { return \\"Hello World\\"; }",
        },
        "Handler": "index.handler",
        "Role": Object {
          "Fn::GetAtt": Array [
            "MyApiLambdaServiceRoleCD73D6D7",
            "Arn",
          ],
        },
        "Runtime": "nodejs22.x",
        "VpcConfig": Object {
          "SecurityGroupIds": Array [
            Object {
              "Fn::GetAtt": Array [
                "MyApiLambdaSecurityGroupDA72A39A",
                "GroupId",
              ],
            },
          ],
          "SubnetIds": Array [
            Object {
              "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet1Subnet536B997AFD4CC940",
            },
            Object {
              "Fn::ImportValue": "SupportStack:ExportsOutputRefVpcPrivateSubnet2Subnet3788AAA1380949A3",
            },
          ],
        },
      },
      "Type": "AWS::Lambda::Function",
    },
    "MyApiLambdaSecurityGroupDA72A39A": Object {
      "Properties": Object {
        "GroupDescription": "Automatic security group for Lambda Function StackMyApiLambda141BCC21",
        "SecurityGroupEgress": Array [
          Object {
            "CidrIp": "0.0.0.0/0",
            "Description": "Allow all outbound traffic by default",
            "IpProtocol": "-1",
          },
        ],
        "VpcId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefVpc8378EB38272D6E3A",
        },
      },
      "Type": "AWS::EC2::SecurityGroup",
    },
    "MyApiLambdaServiceRoleCD73D6D7": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole",
              ],
            ],
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestLambdaApiGatewayAccessLogsAccessLogGroup023FAE9B": Object {
      "DeletionPolicy": "Retain",
      "Properties": Object {
        "RetentionInDays": 180,
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-lambda-api",
          },
        ],
      },
      "Type": "AWS::Logs::LogGroup",
      "UpdateReplacePolicy": "Retain",
    },
    "TestLambdaApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRole6A2B9AE5": Object {
      "Properties": Object {
        "AssumeRolePolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": Object {
                "Service": "apigateway.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": Array [
          Object {
            "Fn::Join": Array [
              "",
              Array [
                "arn:",
                Object {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs",
              ],
            ],
          },
        ],
        "Tags": Array [
          Object {
            "Key": "service",
            "Value": "my-test-lambda-api",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "TestLambdaApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyC05D8122": Object {
      "Properties": Object {
        "PolicyDocument": Object {
          "Statement": Array [
            Object {
              "Action": Array [
                "logs:CreateLogStream",
                "logs:PutLogEvents",
              ],
              "Effect": "Allow",
              "Resource": Object {
                "Fn::GetAtt": Array [
                  "TestLambdaApiGatewayAccessLogsAccessLogGroup023FAE9B",
                  "Arn",
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "TestLambdaApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRoleDefaultPolicyC05D8122",
        "Roles": Array [
          Object {
            "Ref": "TestLambdaApiGatewayAccessLogsApiGatewayPushToCloudwatchLogsRole6A2B9AE5",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "TestLambdaApiGatewayCustomDomainDomainNamemytestlambdaapi341B3917": Object {
      "Properties": Object {
        "DomainName": "my-test-lambda-api.example.com",
        "DomainNameConfigurations": Array [
          Object {
            "CertificateArn": Object {
              "Ref": "TestLambdaApiGatewayCustomDomainHttpsCertificateD4991DAC",
            },
            "EndpointType": "REGIONAL",
            "SecurityPolicy": "TLS_1_2",
          },
        ],
        "Tags": Object {
          "service": "my-test-lambda-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::DomainName",
    },
    "TestLambdaApiGatewayCustomDomainHttpsCertificateD4991DAC": Object {
      "Properties": Object {
        "DomainName": "my-test-lambda-api.example.com",
        "DomainValidationOptions": Array [
          Object {
            "DomainName": "my-test-lambda-api.example.com",
            "HostedZoneId": Object {
              "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
            },
          },
        ],
        "Tags": Array [
          Object {
            "Key": "Name",
            "Value": "Stack/TestLambdaApiGateway/CustomDomain/HttpsCertificate",
          },
          Object {
            "Key": "service",
            "Value": "my-test-lambda-api",
          },
        ],
        "ValidationMethod": "DNS",
      },
      "Type": "AWS::CertificateManager::Certificate",
    },
    "TestLambdaApiGatewayCustomDomainRoute53ARecordApigwAlias4738EC77": Object {
      "Properties": Object {
        "AliasTarget": Object {
          "DNSName": Object {
            "Fn::GetAtt": Array [
              "TestLambdaApiGatewayCustomDomainDomainNamemytestlambdaapi341B3917",
              "RegionalDomainName",
            ],
          },
          "HostedZoneId": Object {
            "Fn::GetAtt": Array [
              "TestLambdaApiGatewayCustomDomainDomainNamemytestlambdaapi341B3917",
              "RegionalHostedZoneId",
            ],
          },
        },
        "HostedZoneId": Object {
          "Fn::ImportValue": "SupportStack:ExportsOutputRefHostedZoneDB99F8662BBAE844",
        },
        "Name": "my-test-lambda-api.example.com.",
        "Type": "A",
      },
      "Type": "AWS::Route53::RecordSet",
    },
    "TestLambdaApiGatewayHttpApimytestlambdaapiAAAA9D6B": Object {
      "Properties": Object {
        "Description": "An HTTP API for my-test-lambda-api.example.com.",
        "DisableExecuteApiEndpoint": true,
        "Name": "HttpApi-my-test-lambda-api",
        "ProtocolType": "HTTP",
        "Tags": Object {
          "service": "my-test-lambda-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::Api",
    },
    "TestLambdaApiGatewayHttpApimytestlambdaapiDefaultStage9E311BF0": Object {
      "DependsOn": Array [
        "TestLambdaApiGatewayCustomDomainDomainNamemytestlambdaapi341B3917",
      ],
      "Properties": Object {
        "AccessLogSettings": Object {
          "DestinationArn": Object {
            "Fn::GetAtt": Array [
              "TestLambdaApiGatewayAccessLogsAccessLogGroup023FAE9B",
              "Arn",
            ],
          },
          "Format": "{\\"requestId\\":\\"$context.requestId\\",\\"userAgent\\":\\"$context.identity.userAgent\\",\\"ip\\":\\"$context.identity.sourceIp\\",\\"requestTime\\":\\"$context.requestTime\\",\\"requestTimeEpoch\\":\\"$context.requestTimeEpoch\\",\\"dataProcessed\\":\\"$context.dataProcessed\\",\\"httpMethod\\":\\"$context.httpMethod\\",\\"path\\":\\"$context.path\\",\\"routeKey\\":\\"$context.routeKey\\",\\"status\\":\\"$context.status\\",\\"protocol\\":\\"$context.protocol\\",\\"responseLength\\":\\"$context.responseLength\\",\\"responseLatency\\":\\"$context.responseLatency\\",\\"domainName\\":\\"$context.domainName\\",\\"error\\":{\\"type\\":\\"$context.error.responseType\\",\\"gatewayError\\":\\"$context.error.message\\",\\"integrationError\\":\\"$context.integration.error\\",\\"authorizerError\\":\\"$context.authorizer.error\\"},\\"integration\\":{\\"latency\\":\\"$context.integration.latency\\",\\"requestId\\":\\"$context.integration.requestId\\",\\"responseStatus\\":\\"$context.integration.status\\"},\\"auth\\":{\\"iam\\":{\\"userArn\\":\\"$context.identity.userArn\\",\\"awsAccount\\":\\"$context.identity.accountId\\",\\"awsPrincipal\\":\\"$context.identity.caller\\",\\"awsPrincipalOrg\\":\\"$context.identity.principalOrgId\\"},\\"basic\\":{\\"user\\":\\"$context.authorizer.user\\"}},\\"awsEndpointRequest\\":{\\"id\\":\\"$context.awsEndpointRequestId\\",\\"id2\\":\\"$context.awsEndpointRequestId2\\"},\\"message\\":\\"$context.identity.sourceIp - $context.httpMethod $context.domainName $context.path ($context.routeKey) - $context.status [$context.responseLatency ms]\\"}",
        },
        "ApiId": Object {
          "Ref": "TestLambdaApiGatewayHttpApimytestlambdaapiAAAA9D6B",
        },
        "AutoDeploy": true,
        "DefaultRouteSettings": Object {
          "DetailedMetricsEnabled": true,
        },
        "StageName": "$default",
        "Tags": Object {
          "service": "my-test-lambda-api",
        },
      },
      "Type": "AWS::ApiGatewayV2::Stage",
    },
    "TestLambdaApiGatewayHttpApimytestlambdaapiDefaultStageStackTestLambdaApiGatewayCustomDomainDomainNamemytestlambdaapiundefinedF42815E5": Object {
      "DependsOn": Array [
        "TestLambdaApiGatewayCustomDomainDomainNamemytestlambdaapi341B3917",
        "TestLambdaApiGatewayHttpApimytestlambdaapiDefaultStage9E311BF0",
      ],
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestLambdaApiGatewayHttpApimytestlambdaapiAAAA9D6B",
        },
        "DomainName": Object {
          "Ref": "TestLambdaApiGatewayCustomDomainDomainNamemytestlambdaapi341B3917",
        },
        "Stage": "$default",
      },
      "Type": "AWS::ApiGatewayV2::ApiMapping",
    },
    "TestLambdaApiGatewayRouteapihello0D3AD6A6": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestLambdaApiGatewayHttpApimytestlambdaapiAAAA9D6B",
        },
        "AuthorizationType": "NONE",
        "RouteKey": "ANY /api/hello",
        "Target": Object {
          "Fn::Join": Array [
            "",
            Array [
              "integrations/",
              Object {
                "Ref": "TestLambdaApiGatewayRouteapihelloLambdaIntegrationD7B01C4D",
              },
            ],
          ],
        },
      },
      "Type": "AWS::ApiGatewayV2::Route",
    },
    "TestLambdaApiGatewayRouteapihelloLambdaIntegrationD7B01C4D": Object {
      "Properties": Object {
        "ApiId": Object {
          "Ref": "TestLambdaApiGatewayHttpApimytestlambdaapiAAAA9D6B",
        },
        "IntegrationType": "AWS_PROXY",
        "IntegrationUri": Object {
          "Fn::GetAtt": Array [
            "MyApiLambdaF4205182",
            "Arn",
          ],
        },
        "PayloadFormatVersion": "2.0",
      },
      "Type": "AWS::ApiGatewayV2::Integration",
    },
    "TestLambdaApiGatewayRouteapihelloLambdaIntegrationPermissionAC3CD06D": Object {
      "Properties": Object {
        "Action": "lambda:InvokeFunction",
        "FunctionName": Object {
          "Fn::GetAtt": Array [
            "MyApiLambdaF4205182",
            "Arn",
          ],
        },
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": Object {
          "Fn::Join": Array [
            "",
            Array [
              "arn:",
              Object {
                "Ref": "AWS::Partition",
              },
              ":execute-api:eu-west-1:",
              Object {
                "Ref": "AWS::AccountId",
              },
              ":",
              Object {
                "Ref": "TestLambdaApiGatewayHttpApimytestlambdaapiAAAA9D6B",
              },
              "/*/*/api/hello",
            ],
          ],
        },
      },
      "Type": "AWS::Lambda::Permission",
    },
  },
}
`;
